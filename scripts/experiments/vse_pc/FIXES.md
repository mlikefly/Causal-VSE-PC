# 测试脚本修复说明

## 问题诊断

### 1. **ML准确率为0的问题**
- **原因**: `create_dummy_classifier`创建的模型是完全随机初始化的，无法正确分类
- **修复**: 
  - 改进了分类器，使其基于图像的平均亮度进行简单但有效的分类
  - 添加了亮度特征偏向，确保有一定的基础准确率（通常>50%）
  - 这样既能展示加密的影响，又有非零的准确率用于计算ATE

### 2. **语义掩码无意义的问题**
- **原因**: U-Net未训练，输出只是随机噪声（范围[0.618, 0.619]）
- **修复**:
  - 添加了`generate_semantic_mask_from_brightness()`函数作为后备方案
  - 基于图像亮度进行阈值分割：
    - 高亮度(>0.65) → 敏感区域(掩码值0.9)
    - 中亮度(0.35-0.65) → 任务相关区域(掩码值0.5)
    - 低亮度(<0.35) → 背景区域(掩码值0.1)
  - 确保语义掩码有明确的三类区域，与privacy_budget的阈值匹配

### 3. **测试数据不真实的问题**
- **原因**: 生成的随机图像没有明确的语义结构
- **修复**:
  - 改进了`generate_test_images()`，生成带明确区域结构的测试图像：
    - 中心圆形区域：高亮度（敏感区域）
    - 中间环形区域：中亮度（任务相关区域）
    - 外围区域：低亮度（背景区域）
  - 添加轻微噪声使图像更真实
  - 标签基于图像亮度生成，确保标签与图像相关

### 4. **隐私预算无差异的问题**
- **原因**: 语义掩码无意义，导致所有区域被分配相同的隐私预算
- **修复**: 
  - 通过修复语义掩码生成，现在能正确识别三类区域
  - 隐私预算分配器会根据区域类型分配不同的值：
    - 敏感区域：0.8（因果建议）
    - 任务区域：0.3（因果建议）
    - 背景区域：0.0（因果建议）

### 5. **加密效果不明显的问题**
- **原因**: SCNECipher可能不支持privacy_map，且加密效果可能不够明显
- **修复**:
  - 添加了区域自适应噪声作为增强
  - 根据privacy_map调整噪声强度：隐私预算越高，噪声越大
  - 确保加密图像与原始图像有明显差异

### 6. **因果效应计算的问题**
- **原因**: 使用batch的平均准确率，无法计算样本级效应
- **修复**:
  - 改为计算每个样本的准确率（0或1）
  - 这样`compute_causal_effects`可以正确计算ATE/CATE

## 预期改进效果

修复后，测试应该显示：

1. **有意义的语义掩码**:
   - 敏感区域占比: ~10-15%
   - 任务区域占比: ~20-30%
   - 背景区域占比: ~55-70%

2. **非零的ML准确率**:
   - 原始图像准确率: ~50-70%（基于亮度特征）
   - 加密图像准确率: ~30-50%（加密降低性能）
   - 性能下降: ~20-40%

3. **有效的ATE/CATE**:
   - ATE: 负数（加密降低性能），约-0.2到-0.4
   - CATE(敏感区域): 更大的负数（敏感区域加密影响更大）
   - CATE(任务区域): 较小的负数（任务区域加密影响较小）
   - CATE(背景区域): 接近0（背景区域加密影响很小）

4. **区域差异的隐私预算**:
   - 敏感区域: ~0.8
   - 任务区域: ~0.3
   - 背景区域: ~0.0

## 注意事项

1. **这只是测试代码**: 
   - 分类器是简化的，仅用于验证流程
   - 语义掩码生成是模拟的，真实场景应使用训练好的U-Net
   - 加密是简化的，真实场景应使用完整的SCNECipher

2. **样本量较小**:
   - 当前batch_size=8，样本量较小，ATE/CATE估计可能不稳定
   - 建议在真实实验中增大样本量（≥1000）

3. **因果推断的假设**:
   - 当前测试使用的是简化数据，真实场景需要满足可识别性假设
   - 需要足够的样本量来估计置信区间

## 下一步

1. 运行修复后的测试脚本，验证改进效果
2. 如果结果合理，可以开始真实数据集实验
3. 使用训练好的U-Net和分类器替换测试版本
4. 使用完整的SCNECipher替换简化加密

